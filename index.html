<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>å­¦ç¿’ãƒ—ãƒ©ãƒ³ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ â€” ã‚µã‚¤ãƒãƒ¼Ã—ã‹ã‚ã„ã„</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #07070b;
            --panel: #0f1117;
            --muted: #bfc8d6;
            --neon-pink: #ff4fa1;
            --neon-cyan: #00f0ff;
            --accent: linear-gradient(90deg,var(--neon-cyan),var(--neon-pink));
            --glass: rgba(255,255,255,0.03);
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(800px 400px at 10% 10%, rgba(0,240,255,0.04), transparent 10%), radial-gradient(700px 350px at 90% 90%, rgba(255,79,161,0.04), transparent 10%), var(--bg);
            color: #e9eef8;
            font-family: 'Poppins',system-ui,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
            padding: 28px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.6rem;
            margin: 0;
            background: linear-gradient(90deg,#fff,#cfecff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 0.6px;
        }

        .sub {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chip {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.04);
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 600;
            color: var(--muted);
            box-shadow: 0 6px 20px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,255,255,0.02);
        }

        .big-btn {
            padding: 10px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            background: var(--accent);
            color: #03060a;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            transition: transform .12s ease, box-shadow .12s;
        }

            .big-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 18px 40px rgba(0,0,0,0.75)
            }

        main {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 20px;
            align-items: start;
        }

        /* å·¦ï¼šãƒ—ãƒ©ãƒ³è¡¨ç¤º */
        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
            border-radius: 14px;
            padding: 18px;
            border: 1px solid rgba(255,255,255,0.04);
            box-shadow: 0 6px 30px rgba(0,0,0,0.6);
        }

            .panel h2 {
                margin: 0 0 12px 0;
                font-size: 1.1rem;
                color: #dffaff
            }

        .plan-list {
            display: block;
            gap: 10px;
            margin-top: 10px
        }

        .task-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 10px;
            background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.03);
            box-shadow: 0 6px 12px rgba(0,0,0,0.45);
            gap: 12px;
            margin-bottom: 8px;
        }

        .task-info {
            display: flex;
            gap: 12px;
            align-items: center;
            min-width: 0
        }

        .task-title {
            font-weight: 700;
            font-size: 0.98rem;
            color: #fff;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            max-width: 40ch
        }

        .task-meta {
            font-size: 0.82rem;
            color: var(--muted)
        }

        .score-badge {
            min-width: 64px;
            text-align: center;
            padding: 6px 10px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(0,240,255,0.06), rgba(255,79,161,0.06));
            color: #cff8ff;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.03)
        }

        .complete-btn {
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255,255,255,0.06);
            transition: all .12s;
        }

            .complete-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 22px rgba(0,0,0,0.5)
            }

        /* å³ï¼šä¿å­˜ï¼†å±¥æ­´ */
        .sidebar {
            position: relative;
        }

            .sidebar h3 {
                margin: 0 0 8px 0;
                color: #cfefff
            }

        .small {
            font-size: 0.9rem;
            color: var(--muted)
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px
        }

        .action-btn {
            padding: 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            background: #0b0f14;
            color: #cfefff;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
            text-align: left;
        }

            .action-btn.secondary {
                background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
                color: var(--muted)
            }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1200
        }

        .modal {
            width: 680px;
            max-width: 95%;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius: 16px;
            padding: 22px;
            border: 1px solid rgba(255,255,255,0.04);
            box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 60px rgba(255,79,161,0.06);
            transform: translateY(-12px);
            opacity: 0;
            transition: all .22s ease;
        }

        .overlay.show {
            display: flex
        }

            .overlay.show .modal {
                transform: translateY(0);
                opacity: 1
            }

        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

            .field label {
                font-size: 0.85rem;
                color: var(--muted)
            }

            .field input[type="text"], .field input[type="number"], .field select {
                background: transparent;
                border-radius: 10px;
                padding: 10px 12px;
                color: #e9eef8;
                border: 1px solid rgba(255,255,255,0.06);
                outline: none;
                font-size: 0.95rem;
                box-shadow: 0 6px 20px rgba(0,0,0,0.6), inset 0 0 14px rgba(255,255,255,0.01);
                transition: box-shadow .12s, border-color .12s;
            }

            .field input:focus {
                border-color: rgba(0,240,255,0.28);
                box-shadow: 0 0 18px rgba(0,240,255,0.08)
            }

        .wide {
            grid-column: 1 / -1
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 14px
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.06);
            padding: 10px 14px;
            border-radius: 10px;
            color: var(--muted);
            cursor: pointer
        }

        .btn-primary {
            background: var(--accent);
            color: #03060a;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 800
        }

        /* praise bubble */
        .praise-wrap {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 24px;
            z-index: 1300;
            pointer-events: none;
        }

        .praise {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            border-radius: 999px;
            background: linear-gradient(90deg,#ff9ac4,#b9ffff);
            color: #071018;
            font-weight: 700;
            box-shadow: 0 18px 40px rgba(0,0,0,0.5);
            transform: translateY(40px);
            opacity: 0;
            transition: all .45s cubic-bezier(.2,.9,.2,1);
        }

            .praise.show {
                transform: translateY(0);
                opacity: 1
            }
        /* tiny hearts */
        .hearts {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 86px;
            pointer-events: none;
        }

            .hearts span {
                position: absolute;
                font-size: 18px;
                opacity: 0;
                transform: translateY(0) scale(0.6);
                animation: floatUp 1600ms ease forwards;
            }

        @keyframes floatUp {
            0% {
                opacity: 0;
                transform: translateY(0) scale(.6)
            }

            10% {
                opacity: 1;
                transform: translateY(-8px) scale(1)
            }

            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.2)
            }
        }

        /* responsive */
        @media (max-width:820px) {
            main {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>å­¦ç¿’ãƒ—ãƒ©ãƒ³ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <div class="sub">ã‚µã‚¤ãƒãƒ¼ãƒã‚ªãƒ³ Ã— ã‹ã‚ã„ã„ â€” å„ªå…ˆåº¦ã§è‡ªå‹•ã‚½ãƒ¼ãƒˆ</div>
        </div>

        <div class="controls">
            <div class="chip">ç¾åœ¨ã®ç©ºãæ™‚é–“: <strong id="currentAvailable">â€”</strong> åˆ†</div>
            <button class="big-btn" id="openCreate">ï¼‹ äºˆå®šä½œæˆï¼</button>
        </div>
    </header>

    <main>
        <!-- å·¦ï¼šãƒ—ãƒ©ãƒ³ -->
        <section class="panel">
            <h2>ã‚„ã‚‹ã¹ãã“ã¨ï¼ˆå„ªå…ˆåº¦é †ï¼‰</h2>
            <div id="planArea" class="plan-list">
                <!-- ã‚¿ã‚¹ã‚¯è¡ŒãŒã“ã“ã«å…¥ã‚‹ -->
            </div>

            <div style="margin-top:12px; display:flex; gap:10px; align-items:center; justify-content:flex-end">
                <button class="action-btn secondary" id="clearAll">å…¨ã¦å‰Šé™¤</button>
                <button class="action-btn" id="saveBtn">ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜</button>
            </div>
        </section>

        <!-- å³ï¼šæƒ…å ± -->
        <aside class="sidebar panel">
            <h3>ãƒ˜ãƒ«ãƒ—</h3>
            <div class="small">ã€Œäºˆå®šä½œæˆï¼ã€ã§ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã™ã‚‹ã¨ã€<br>è‡ªå‹•çš„ã«å„ªå…ˆåº¦ï¼ˆé‡è¦åº¦Ã—2 + ç·Šæ€¥åº¦Ã—2 âˆ’ é€²æ—åº¦/10ï¼‰ã§ä¸¦ã³æ›¿ãˆã¾ã™ã€‚</div>

            <div style="margin-top:14px">
                <div class="small">ä¿å­˜ãƒ»å¾©å…ƒ</div>
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button class="action-btn" id="loadBtn">ä¿å­˜ã‚’å¾©å…ƒ</button>
                    <button class="action-btn secondary" id="exportBtn">JSON ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
        </aside>
    </main>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ -->
    <div class="overlay" id="overlay">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
                <h2 id="modalTitle" style="margin:0;color:#dffaff">äºˆå®šã‚’ä½œæˆã™ã‚‹</h2>
                <div style="color:var(--muted);font-size:0.9rem">Cyber Cute Form</div>
            </div>

            <div class="modal-grid" style="margin-top:12px">
                <div class="field wide">
                    <label>ç©ºãæ™‚é–“ï¼ˆåˆ†ï¼‰ â€” å…¨ä½“ã®ä½¿ç”¨å¯èƒ½æ™‚é–“ï¼ˆãƒ—ãƒ©ãƒ³ç”Ÿæˆã«ä½¿ã„ã¾ã™ï¼‰</label>
                    <input id="availableInput" type="number" placeholder="ä¾‹: 60" min="0">
                </div>

                <div class="field">
                    <label>ã‚¿ã‚¹ã‚¯å</label>
                    <input id="taskName" type="text" placeholder="ä¾‹: ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å‹‰å¼·">
                </div>

                <div class="field">
                    <label>æ‰€è¦æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                    <input id="taskDuration" type="number" placeholder="ä¾‹: 30" min="1">
                </div>

                <div class="field">
                    <label>é‡è¦åº¦ï¼ˆ1-10ï¼‰</label>
                    <input id="taskImportance" type="number" min="1" max="10" placeholder="5">
                </div>

                <div class="field">
                    <label>ç·Šæ€¥åº¦ï¼ˆ1-10ï¼‰</label>
                    <input id="taskUrgency" type="number" min="1" max="10" placeholder="3">
                </div>

                <div class="field">
                    <label>é€²æ—åº¦ï¼ˆ0-100ï¼‰</label>
                    <input id="taskProgress" type="number" min="0" max="100" placeholder="0">
                </div>

                <div class="field wide">
                    <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                    <input id="taskNote" type="text" placeholder="è£œè¶³ã‚„ãƒªãƒ³ã‚¯ãªã©">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-ghost" id="cancelModal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" id="addTaskBtn">è¿½åŠ ã—ã¦é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- è¤’ã‚å¹ãå‡ºã—ï¼†ãƒãƒ¼ãƒˆ -->
    <div class="praise-wrap" aria-hidden="true">
        <div class="praise" id="praiseBubble">ãŠç–²ã‚Œã•ã¾ã€ã”ä¸»äººæ§˜â™¡ ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸã­ï¼</div>
        <div class="hearts" id="heartsContainer"></div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        let tasks = []; // { id, name, duration, importance, urgency, progress, note, score, created }
        let availableTime = null;

        // utils
        const $ = (id) => document.getElementById(id);

        // åˆæœŸåŒ–ï¼šä¿å­˜ãŒã‚ã‚Œã°å¾©å…ƒ
        window.addEventListener('DOMContentLoaded', () => {
            const raw = localStorage.getItem('cyberTasks_v1');
            const time = localStorage.getItem('cyberAvailable_v1');
            if (raw) {
                try {
                    tasks = JSON.parse(raw);
                    sortAndRender();
                } catch (e) { tasks = []; }
            }
            if (time) {
                availableTime = Number(time);
                $('currentAvailable').textContent = availableTime;
            } else {
                $('currentAvailable').textContent = 'â€”';
            }
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
        const overlay = $('overlay');
        $('openCreate').addEventListener('click', () => openModal());
        $('cancelModal').addEventListener('click', closeModal);
        overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(); });

        function openModal() {
            // åˆæœŸå€¤ãƒªã‚»ãƒƒãƒˆ
            $('taskName').value = '';
            $('taskDuration').value = '';
            $('taskImportance').value = 5;
            $('taskUrgency').value = 5;
            $('taskProgress').value = 0;
            $('taskNote').value = '';
            $('availableInput').value = availableTime !== null ? availableTime : '';
            overlay.classList.add('show');
            overlay.style.display = 'flex';
            setTimeout(() => $('taskName').focus(), 120);
        }
        function closeModal() {
            overlay.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 220);
        }

        // è¿½åŠ å‡¦ç†
        $('addTaskBtn').addEventListener('click', () => {
            const name = $('taskName').value.trim();
            const duration = parseInt($('taskDuration').value);
            const importance = parseInt($('taskImportance').value);
            const urgency = parseInt($('taskUrgency').value);
            const progress = parseInt($('taskProgress').value);
            const note = $('taskNote').value.trim();
            const avail = $('availableInput').value.trim();

            if (!name) { alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); $('taskName').focus(); return; }
            if (isNaN(duration) || duration <= 0) { alert('æ‰€è¦æ™‚é–“ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); $('taskDuration').focus(); return; }
            if (isNaN(importance) || importance < 1 || importance > 10) { alert('é‡è¦åº¦ã¯1ã€œ10ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); $('taskImportance').focus(); return; }
            if (isNaN(urgency) || urgency < 1 || urgency > 10) { alert('ç·Šæ€¥åº¦ã¯1ã€œ10ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); $('taskUrgency').focus(); return; }
            if (isNaN(progress) || progress < 0 || progress > 100) { alert('é€²æ—åº¦ã¯0ã€œ100ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); $('taskProgress').focus(); return; }

            if (avail !== '') {
                const parsed = Number(avail);
                if (!isNaN(parsed) && parsed >= 0) {
                    availableTime = parsed;
                    localStorage.setItem('cyberAvailable_v1', String(availableTime));
                    $('currentAvailable').textContent = availableTime;
                }
            }

            const id = Date.now() + Math.floor(Math.random() * 999);
            const score = calcScore(importance, urgency, progress);
            tasks.push({ id, name, duration, importance, urgency, progress, note, score, created: Date.now() });
            saveLocal();
            sortAndRender();
            closeModal();
            showPraise(`${name} ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã‚ˆãè€ƒãˆã¦é¸ã³ã¾ã—ãŸã­ã€ã”ä¸»äººæ§˜â™¡`);
        });

        function calcScore(importance, urgency, progress) {
            return (importance * 2) + (urgency * 2) - (progress / 10);
        }

        // ä¸¦ã³æ›¿ãˆâ†’æç”»
        function sortAndRender() {
            tasks.sort((a, b) => {
                if (b.score === a.score) return b.created - a.created;
                return b.score - a.score;
            });
            renderTasks();
        }

        function renderTasks() {
            const area = $('planArea');
            area.innerHTML = '';
            if (tasks.length === 0) {
                area.innerHTML = `<div style="color:var(--muted);padding:18px;border-radius:10px;background:rgba(255,255,255,0.01)">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œäºˆå®šä½œæˆï¼ã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
                return;
            }

            // ãƒ«ãƒ¼ãƒ—è¡¨ç¤º
            tasks.forEach((t, idx) => {
                const row = document.createElement('div');
                row.className = 'task-row';
                const info = document.createElement('div');
                info.className = 'task-info';
                info.innerHTML = `<div style="width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,var(--neon-cyan),var(--neon-pink));box-shadow:0 4px 14px rgba(255,79,161,0.08)"></div>
                            <div>
                              <div class="task-title">${escapeHtml(t.name)}</div>
                              <div class="task-meta">${t.duration} åˆ† ãƒ» é‡è¦:${t.importance} ç·Šæ€¥:${t.urgency} é€²æ—:${t.progress}% ${t.note ? 'ãƒ»' + escapeHtml(t.note) : ''}</div>
                            </div>`;

                const right = document.createElement('div');
                right.style.display = 'flex'; right.style.gap = '10px'; right.style.alignItems = 'center';
                const badge = document.createElement('div');
                badge.className = 'score-badge';
                badge.textContent = `å„ªå…ˆ ${t.score.toFixed(1)}`;

                const complete = document.createElement('button');
                complete.className = 'complete-btn';
                complete.textContent = 'å®Œäº†ï¼';
                complete.addEventListener('click', () => completeTask(t.id, t.name));

                right.appendChild(badge);
                right.appendChild(complete);

                row.appendChild(info);
                row.appendChild(right);

                area.appendChild(row);
            });

            // show remaining time plan (greedy fill)
            renderPlanPreview();
        }

        function renderPlanPreview() {
            // Determine plan selection by availableTime
            const container = document.createElement('div');
            container.style.marginTop = '12px';
            container.style.paddingTop = '6px';
            container.style.borderTop = '1px dashed rgba(255,255,255,0.02)';
            if (availableTime === null) {
                container.innerHTML = `<div style="color:var(--muted);margin-top:8px">ç©ºãæ™‚é–“ã‚’è¨­å®šã™ã‚‹ã¨ã€ãã®æ™‚é–“å†…ã§å®Ÿè¡Œå¯èƒ½ãªã‚¿ã‚¹ã‚¯ã‚’ä¸Šã‹ã‚‰è©°ã‚ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</div>`;
            } else {
                let used = 0;
                const picks = [];
                for (const t of tasks) {
                    if (used + t.duration <= availableTime) {
                        picks.push(t);
                        used += t.duration;
                    }
                }
                const remain = availableTime - used;
                container.innerHTML = `<div style="margin-top:8px;font-weight:700;color:#dffaff">ä»Šã®ç©ºãæ™‚é–“ ${availableTime} åˆ† â€” å®Ÿè¡Œå€™è£œï¼ˆ${picks.length} ä»¶ï¼‰ï¼š</div>`;
                if (picks.length === 0) {
                    container.innerHTML += `<div style="color:var(--muted);margin-top:6px">æ™‚é–“å†…ã«å…¥ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
                } else {
                    container.innerHTML += '<div style="margin-top:8px">';
                    picks.forEach(p => {
                        container.innerHTML += `<div style="padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.01);display:flex;justify-content:space-between"><div style="font-weight:700">${escapeHtml(p.name)}</div><div style="color:var(--muted)">${p.duration} åˆ†</div></div>`;
                    });
                    container.innerHTML += `</div><div style="color:var(--muted);margin-top:8px">æ®‹ã‚Šæ™‚é–“: ${remain} åˆ†</div>`;
                }
            }
            // remove previous preview if exists
            const prev = document.querySelector('.panel .plan-preview');
            // append after first child (header)
            const panel = document.querySelector('.panel');
            // remove previous appended preview nodes inside panel (we'll ensure only one preview inserted)
            const existing = panel.querySelector('.plan-preview-wrapper');
            if (existing) existing.remove();

            const wrapper = document.createElement('div');
            wrapper.className = 'plan-preview-wrapper';
            wrapper.appendChild(container);
            panel.appendChild(wrapper);
        }

        const praiseTexts = [
            'å®Œäº†ï¼ã™ã”ã„ã§ã™ã­ã€ã”ä¸»äººæ§˜â™¡',
            'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼å®Œç’§ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã§ã™â™¡',
            'æµçŸ³ã§ã™ã€ã”ä¸»äººæ§˜ï¼æ¬¡ã®ã‚¿ã‚¹ã‚¯ã‚‚ã“ã®èª¿å­ã§ã„ãã¾ã—ã‚‡ã†ï¼',
            'ã‚„ã£ãŸã­ï¼ä»Šæ—¥ã®ã”è¤’ç¾ã¯ä½•ã«ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ'
        ];

        function getRandomPraiseText() {
            return praiseTexts[Math.floor(Math.random() * praiseTexts.length)];
        }

        function completeTask(id, name) {
            const idx = tasks.findIndex(t => t.id === id);
            if (idx === -1) return;
            tasks.splice(idx, 1);
            saveLocal();
            sortAndRender();
            // show praise + hearts
            showPraise(`${getRandomPraiseText()}`); // ä¿®æ­£ç‚¹
            spawnHearts();
        }

        // Praise bubble
        const praise = $('praiseBubble');
        const heartsContainer = $('heartsContainer');
        let praiseTimer = null;
        function showPraise(text) {
            praise.textContent = text;
            praise.classList.add('show');
            if (praiseTimer) clearTimeout(praiseTimer);
            praiseTimer = setTimeout(() => { praise.classList.remove('show') }, 2200);
        }

        function spawnHearts() {
            // create a few hearts with staggered animations
            heartsContainer.innerHTML = '';
            const icons = ['ğŸ’–', 'ğŸ’—', 'âœ¨', 'ğŸ’«'];
            for (let i = 0; i < 6; i++) {
                const sp = document.createElement('span');
                sp.style.left = (50 + (Math.random() * 160 - 80)) + 'px';
                sp.style.animationDelay = (Math.random() * 600) + 'ms';
                sp.textContent = icons[Math.floor(Math.random() * icons.length)];
                heartsContainer.appendChild(sp);
            }
            // force reflow + restart animation by replacing nodes (handled via CSS animation on insertion)
            setTimeout(() => heartsContainer.innerHTML = '', 1600);
        }

        // Save / Load local
        function saveLocal() {
            localStorage.setItem('cyberTasks_v1', JSON.stringify(tasks));
        }
        $('saveBtn').addEventListener('click', () => {
            saveLocal();
            localStorage.setItem('cyberAvailable_v1', availableTime !== null ? String(availableTime) : '');
            showPraise('ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸã€ã”ä¸»äººæ§˜â™¡');
        });
        $('loadBtn').addEventListener('click', () => {
            const raw = localStorage.getItem('cyberTasks_v1');
            const time = localStorage.getItem('cyberAvailable_v1');
            if (raw) {
                try { tasks = JSON.parse(raw); } catch (e) { tasks = []; alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
                if (time) { availableTime = Number(time); $('currentAvailable').textContent = availableTime; }
                sortAndRender();
                showPraise('ä¿å­˜ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
            } else {
                alert('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        });
        $('clearAll').addEventListener('click', () => {
            if (!confirm('å…¨ã¦ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            tasks = []; saveLocal(); renderTasks();
            showPraise('å…¨éƒ¨ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€ã”ä¸»äººæ§˜â™¡');
        });

        // Export JSON
        $('exportBtn').addEventListener('click', () => {
            const data = { availableTime, tasks };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'study_plan.json'; a.click();
            URL.revokeObjectURL(url);
            showPraise('JSON ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸâ™¡');
        });

        // helper: escape for safe HTML injection
        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }
    </script>
</body>
</html>
