<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>学習プランジェネレーター — サイバー×かわいい</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #07070b;
            --panel: #0f1117;
            --muted: #bfc8d6;
            --neon-pink: #ff4fa1;
            --neon-cyan: #00f0ff;
            --accent: linear-gradient(90deg,var(--neon-cyan),var(--neon-pink));
            --glass: rgba(255,255,255,0.03);
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(800px 400px at 10% 10%, rgba(0,240,255,0.04), transparent 10%), radial-gradient(700px 350px at 90% 90%, rgba(255,79,161,0.04), transparent 10%), var(--bg);
            color: #e9eef8;
            font-family: 'Poppins',system-ui,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
            padding: 28px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.6rem;
            margin: 0;
            background: linear-gradient(90deg,#fff,#cfecff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 0.6px;
        }

        .sub {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chip {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.04);
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 600;
            color: var(--muted);
            box-shadow: 0 6px 20px rgba(0,0,0,0.6), inset 0 0 12px rgba(255,255,255,0.02);
        }

        .big-btn {
            padding: 10px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            background: var(--accent);
            color: #03060a;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            transition: transform .12s ease, box-shadow .12s;
        }

            .big-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 18px 40px rgba(0,0,0,0.75)
            }

        main {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 20px;
            align-items: start;
        }

        /* 左：プラン表示 */
        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
            border-radius: 14px;
            padding: 18px;
            border: 1px solid rgba(255,255,255,0.04);
            box-shadow: 0 6px 30px rgba(0,0,0,0.6);
        }

            .panel h2 {
                margin: 0 0 12px 0;
                font-size: 1.1rem;
                color: #dffaff
            }

        .plan-list {
            display: block;
            gap: 10px;
            margin-top: 10px
        }

        .task-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 10px;
            background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.03);
            box-shadow: 0 6px 12px rgba(0,0,0,0.45);
            gap: 12px;
            margin-bottom: 8px;
        }

        .task-info {
            display: flex;
            gap: 12px;
            align-items: center;
            min-width: 0
        }

        .task-title {
            font-weight: 700;
            font-size: 0.98rem;
            color: #fff;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            max-width: 40ch
        }

        .task-meta {
            font-size: 0.82rem;
            color: var(--muted)
        }

        .score-badge {
            min-width: 64px;
            text-align: center;
            padding: 6px 10px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(0,240,255,0.06), rgba(255,79,161,0.06));
            color: #cff8ff;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.03)
        }

        .complete-btn {
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255,255,255,0.06);
            transition: all .12s;
        }

            .complete-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 22px rgba(0,0,0,0.5)
            }

        /* 右：保存＆履歴 */
        .sidebar {
            position: relative;
        }

            .sidebar h3 {
                margin: 0 0 8px 0;
                color: #cfefff
            }

        .small {
            font-size: 0.9rem;
            color: var(--muted)
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px
        }

        .action-btn {
            padding: 12px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            background: #0b0f14;
            color: #cfefff;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
            text-align: left;
        }

            .action-btn.secondary {
                background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
                color: var(--muted)
            }

        /* モーダル */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1200
        }

        .modal {
            width: 680px;
            max-width: 95%;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius: 16px;
            padding: 22px;
            border: 1px solid rgba(255,255,255,0.04);
            box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 60px rgba(255,79,161,0.06);
            transform: translateY(-12px);
            opacity: 0;
            transition: all .22s ease;
        }

        .overlay.show {
            display: flex
        }

            .overlay.show .modal {
                transform: translateY(0);
                opacity: 1
            }

        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

            .field label {
                font-size: 0.85rem;
                color: var(--muted)
            }

            .field input[type="text"], .field input[type="number"], .field select {
                background: transparent;
                border-radius: 10px;
                padding: 10px 12px;
                color: #e9eef8;
                border: 1px solid rgba(255,255,255,0.06);
                outline: none;
                font-size: 0.95rem;
                box-shadow: 0 6px 20px rgba(0,0,0,0.6), inset 0 0 14px rgba(255,255,255,0.01);
                transition: box-shadow .12s, border-color .12s;
            }

            .field input:focus {
                border-color: rgba(0,240,255,0.28);
                box-shadow: 0 0 18px rgba(0,240,255,0.08)
            }

        .wide {
            grid-column: 1 / -1
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 14px
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.06);
            padding: 10px 14px;
            border-radius: 10px;
            color: var(--muted);
            cursor: pointer
        }

        .btn-primary {
            background: var(--accent);
            color: #03060a;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 800
        }

        /* praise bubble */
        .praise-wrap {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 24px;
            z-index: 1300;
            pointer-events: none;
        }

        .praise {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            border-radius: 999px;
            background: linear-gradient(90deg,#ff9ac4,#b9ffff);
            color: #071018;
            font-weight: 700;
            box-shadow: 0 18px 40px rgba(0,0,0,0.5);
            transform: translateY(40px);
            opacity: 0;
            transition: all .45s cubic-bezier(.2,.9,.2,1);
        }

            .praise.show {
                transform: translateY(0);
                opacity: 1
            }
        /* tiny hearts */
        .hearts {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 86px;
            pointer-events: none;
        }

            .hearts span {
                position: absolute;
                font-size: 18px;
                opacity: 0;
                transform: translateY(0) scale(0.6);
                animation: floatUp 1600ms ease forwards;
            }

        @keyframes floatUp {
            0% {
                opacity: 0;
                transform: translateY(0) scale(.6)
            }

            10% {
                opacity: 1;
                transform: translateY(-8px) scale(1)
            }

            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.2)
            }
        }

        /* responsive */
        @media (max-width:820px) {
            main {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>学習プランジェネレーター</h1>
            <div class="sub">サイバーネオン × かわいい — 優先度で自動ソート</div>
        </div>

        <div class="controls">
            <div class="chip">現在の空き時間: <strong id="currentAvailable">—</strong> 分</div>
            <button class="big-btn" id="openCreate">＋ 予定作成！</button>
        </div>
    </header>

    <main>
        <!-- 左：プラン -->
        <section class="panel">
            <h2>やるべきこと（優先度順）</h2>
            <div id="planArea" class="plan-list">
                <!-- タスク行がここに入る -->
            </div>

            <div style="margin-top:12px; display:flex; gap:10px; align-items:center; justify-content:flex-end">
                <button class="action-btn secondary" id="clearAll">全て削除</button>
                <button class="action-btn" id="saveBtn">ローカルに保存</button>
            </div>
        </section>

        <!-- 右：情報 -->
        <aside class="sidebar panel">
            <h3>ヘルプ</h3>
            <div class="small">「予定作成！」でタスクを追加すると、<br>自動的に優先度（重要度×2 + 緊急度×2 − 進捗度/10）で並び替えます。</div>

            <div style="margin-top:14px">
                <div class="small">保存・復元</div>
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button class="action-btn" id="loadBtn">保存を復元</button>
                    <button class="action-btn secondary" id="exportBtn">JSON エクスポート</button>
                </div>
            </div>
        </aside>
    </main>

    <!-- モーダル（入力フォーム） -->
    <div class="overlay" id="overlay">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
                <h2 id="modalTitle" style="margin:0;color:#dffaff">予定を作成する</h2>
                <div style="color:var(--muted);font-size:0.9rem">Cyber Cute Form</div>
            </div>

            <div class="modal-grid" style="margin-top:12px">
                <div class="field wide">
                    <label>空き時間（分） — 全体の使用可能時間（プラン生成に使います）</label>
                    <input id="availableInput" type="number" placeholder="例: 60" min="0">
                </div>

                <div class="field">
                    <label>タスク名</label>
                    <input id="taskName" type="text" placeholder="例: アルゴリズム勉強">
                </div>

                <div class="field">
                    <label>所要時間（分）</label>
                    <input id="taskDuration" type="number" placeholder="例: 30" min="1">
                </div>

                <div class="field">
                    <label>重要度（1-10）</label>
                    <input id="taskImportance" type="number" min="1" max="10" placeholder="5">
                </div>

                <div class="field">
                    <label>緊急度（1-10）</label>
                    <input id="taskUrgency" type="number" min="1" max="10" placeholder="3">
                </div>

                <div class="field">
                    <label>進捗度（0-100）</label>
                    <input id="taskProgress" type="number" min="0" max="100" placeholder="0">
                </div>

                <div class="field wide">
                    <label>メモ（任意）</label>
                    <input id="taskNote" type="text" placeholder="補足やリンクなど">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-ghost" id="cancelModal">キャンセル</button>
                <button class="btn-primary" id="addTaskBtn">追加して閉じる</button>
            </div>
        </div>
    </div>

    <!-- 褒め吹き出し＆ハート -->
    <div class="praise-wrap" aria-hidden="true">
        <div class="praise" id="praiseBubble">お疲れさま、ご主人様♡ よく頑張りましたね！</div>
        <div class="hearts" id="heartsContainer"></div>
    </div>

    <script>
        // データ構造
        let tasks = []; // { id, name, duration, importance, urgency, progress, note, score, created }
        let availableTime = null;

        // utils
        const $ = (id) => document.getElementById(id);

        // 初期化：保存があれば復元
        window.addEventListener('DOMContentLoaded', () => {
            const raw = localStorage.getItem('cyberTasks_v1');
            const time = localStorage.getItem('cyberAvailable_v1');
            if (raw) {
                try {
                    tasks = JSON.parse(raw);
                    sortAndRender();
                } catch (e) { tasks = []; }
            }
            if (time) {
                availableTime = Number(time);
                $('currentAvailable').textContent = availableTime;
            } else {
                $('currentAvailable').textContent = '—';
            }
        });

        // モーダル開閉
        const overlay = $('overlay');
        $('openCreate').addEventListener('click', () => openModal());
        $('cancelModal').addEventListener('click', closeModal);
        overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(); });

        function openModal() {
            // 初期値リセット
            $('taskName').value = '';
            $('taskDuration').value = '';
            $('taskImportance').value = 5;
            $('taskUrgency').value = 5;
            $('taskProgress').value = 0;
            $('taskNote').value = '';
            $('availableInput').value = availableTime !== null ? availableTime : '';
            overlay.classList.add('show');
            overlay.style.display = 'flex';
            setTimeout(() => $('taskName').focus(), 120);
        }
        function closeModal() {
            overlay.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 220);
        }

        // 追加処理
        $('addTaskBtn').addEventListener('click', () => {
            const name = $('taskName').value.trim();
            const duration = parseInt($('taskDuration').value);
            const importance = parseInt($('taskImportance').value);
            const urgency = parseInt($('taskUrgency').value);
            const progress = parseInt($('taskProgress').value);
            const note = $('taskNote').value.trim();
            const avail = $('availableInput').value.trim();

            if (!name) { alert('タスク名を入力してください'); $('taskName').focus(); return; }
            if (isNaN(duration) || duration <= 0) { alert('所要時間を正しく入力してください'); $('taskDuration').focus(); return; }
            if (isNaN(importance) || importance < 1 || importance > 10) { alert('重要度は1〜10で入力してください'); $('taskImportance').focus(); return; }
            if (isNaN(urgency) || urgency < 1 || urgency > 10) { alert('緊急度は1〜10で入力してください'); $('taskUrgency').focus(); return; }
            if (isNaN(progress) || progress < 0 || progress > 100) { alert('進捗度は0〜100で入力してください'); $('taskProgress').focus(); return; }

            if (avail !== '') {
                const parsed = Number(avail);
                if (!isNaN(parsed) && parsed >= 0) {
                    availableTime = parsed;
                    localStorage.setItem('cyberAvailable_v1', String(availableTime));
                    $('currentAvailable').textContent = availableTime;
                }
            }

            const id = Date.now() + Math.floor(Math.random() * 999);
            const score = calcScore(importance, urgency, progress);
            tasks.push({ id, name, duration, importance, urgency, progress, note, score, created: Date.now() });
            saveLocal();
            sortAndRender();
            closeModal();
            showPraise(`${name} を追加しました。よく考えて選びましたね、ご主人様♡`);
        });

        function calcScore(importance, urgency, progress) {
            return (importance * 2) + (urgency * 2) - (progress / 10);
        }

        // 並び替え→描画
        function sortAndRender() {
            tasks.sort((a, b) => {
                if (b.score === a.score) return b.created - a.created;
                return b.score - a.score;
            });
            renderTasks();
        }

        function renderTasks() {
            const area = $('planArea');
            area.innerHTML = '';
            if (tasks.length === 0) {
                area.innerHTML = `<div style="color:var(--muted);padding:18px;border-radius:10px;background:rgba(255,255,255,0.01)">予定がありません。右上の「予定作成！」で追加してください。</div>`;
                return;
            }

            // ループ表示
            tasks.forEach((t, idx) => {
                const row = document.createElement('div');
                row.className = 'task-row';
                const info = document.createElement('div');
                info.className = 'task-info';
                info.innerHTML = `<div style="width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,var(--neon-cyan),var(--neon-pink));box-shadow:0 4px 14px rgba(255,79,161,0.08)"></div>
                            <div>
                              <div class="task-title">${escapeHtml(t.name)}</div>
                              <div class="task-meta">${t.duration} 分 ・ 重要:${t.importance} 緊急:${t.urgency} 進捗:${t.progress}% ${t.note ? '・' + escapeHtml(t.note) : ''}</div>
                            </div>`;

                const right = document.createElement('div');
                right.style.display = 'flex'; right.style.gap = '10px'; right.style.alignItems = 'center';
                const badge = document.createElement('div');
                badge.className = 'score-badge';
                badge.textContent = `優先 ${t.score.toFixed(1)}`;

                const complete = document.createElement('button');
                complete.className = 'complete-btn';
                complete.textContent = '完了！';
                complete.addEventListener('click', () => completeTask(t.id, t.name));

                right.appendChild(badge);
                right.appendChild(complete);

                row.appendChild(info);
                row.appendChild(right);

                area.appendChild(row);
            });

            // show remaining time plan (greedy fill)
            renderPlanPreview();
        }

        function renderPlanPreview() {
            // Determine plan selection by availableTime
            const container = document.createElement('div');
            container.style.marginTop = '12px';
            container.style.paddingTop = '6px';
            container.style.borderTop = '1px dashed rgba(255,255,255,0.02)';
            if (availableTime === null) {
                container.innerHTML = `<div style="color:var(--muted);margin-top:8px">空き時間を設定すると、その時間内で実行可能なタスクを上から詰めて表示します。</div>`;
            } else {
                let used = 0;
                const picks = [];
                for (const t of tasks) {
                    if (used + t.duration <= availableTime) {
                        picks.push(t);
                        used += t.duration;
                    }
                }
                const remain = availableTime - used;
                container.innerHTML = `<div style="margin-top:8px;font-weight:700;color:#dffaff">今の空き時間 ${availableTime} 分 — 実行候補（${picks.length} 件）：</div>`;
                if (picks.length === 0) {
                    container.innerHTML += `<div style="color:var(--muted);margin-top:6px">時間内に入るタスクがありません。</div>`;
                } else {
                    container.innerHTML += '<div style="margin-top:8px">';
                    picks.forEach(p => {
                        container.innerHTML += `<div style="padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.01);display:flex;justify-content:space-between"><div style="font-weight:700">${escapeHtml(p.name)}</div><div style="color:var(--muted)">${p.duration} 分</div></div>`;
                    });
                    container.innerHTML += `</div><div style="color:var(--muted);margin-top:8px">残り時間: ${remain} 分</div>`;
                }
            }
            // remove previous preview if exists
            const prev = document.querySelector('.panel .plan-preview');
            // append after first child (header)
            const panel = document.querySelector('.panel');
            // remove previous appended preview nodes inside panel (we'll ensure only one preview inserted)
            const existing = panel.querySelector('.plan-preview-wrapper');
            if (existing) existing.remove();

            const wrapper = document.createElement('div');
            wrapper.className = 'plan-preview-wrapper';
            wrapper.appendChild(container);
            panel.appendChild(wrapper);
        }

        const praiseTexts = [
            '完了！すごいですね、ご主人様♡',
            'お疲れ様でした！完璧なパフォーマンスです♡',
            '流石です、ご主人様！次のタスクもこの調子でいきましょう！',
            'やったね！今日のご褒美は何にしましょうか？'
        ];

        function getRandomPraiseText() {
            return praiseTexts[Math.floor(Math.random() * praiseTexts.length)];
        }

        function completeTask(id, name) {
            const idx = tasks.findIndex(t => t.id === id);
            if (idx === -1) return;
            tasks.splice(idx, 1);
            saveLocal();
            sortAndRender();
            // show praise + hearts
            showPraise(`${getRandomPraiseText()}`); // 修正点
            spawnHearts();
        }

        // Praise bubble
        const praise = $('praiseBubble');
        const heartsContainer = $('heartsContainer');
        let praiseTimer = null;
        function showPraise(text) {
            praise.textContent = text;
            praise.classList.add('show');
            if (praiseTimer) clearTimeout(praiseTimer);
            praiseTimer = setTimeout(() => { praise.classList.remove('show') }, 2200);
        }

        function spawnHearts() {
            // create a few hearts with staggered animations
            heartsContainer.innerHTML = '';
            const icons = ['💖', '💗', '✨', '💫'];
            for (let i = 0; i < 6; i++) {
                const sp = document.createElement('span');
                sp.style.left = (50 + (Math.random() * 160 - 80)) + 'px';
                sp.style.animationDelay = (Math.random() * 600) + 'ms';
                sp.textContent = icons[Math.floor(Math.random() * icons.length)];
                heartsContainer.appendChild(sp);
            }
            // force reflow + restart animation by replacing nodes (handled via CSS animation on insertion)
            setTimeout(() => heartsContainer.innerHTML = '', 1600);
        }

        // Save / Load local
        function saveLocal() {
            localStorage.setItem('cyberTasks_v1', JSON.stringify(tasks));
        }
        $('saveBtn').addEventListener('click', () => {
            saveLocal();
            localStorage.setItem('cyberAvailable_v1', availableTime !== null ? String(availableTime) : '');
            showPraise('ローカルに保存しました、ご主人様♡');
        });
        $('loadBtn').addEventListener('click', () => {
            const raw = localStorage.getItem('cyberTasks_v1');
            const time = localStorage.getItem('cyberAvailable_v1');
            if (raw) {
                try { tasks = JSON.parse(raw); } catch (e) { tasks = []; alert('復元に失敗しました'); return; }
                if (time) { availableTime = Number(time); $('currentAvailable').textContent = availableTime; }
                sortAndRender();
                showPraise('保存を復元しました');
            } else {
                alert('保存データが見つかりません');
            }
        });
        $('clearAll').addEventListener('click', () => {
            if (!confirm('全ての予定を削除しますか？')) return;
            tasks = []; saveLocal(); renderTasks();
            showPraise('全部リセットしました、ご主人様♡');
        });

        // Export JSON
        $('exportBtn').addEventListener('click', () => {
            const data = { availableTime, tasks };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'study_plan.json'; a.click();
            URL.revokeObjectURL(url);
            showPraise('JSON をエクスポートしました♡');
        });

        // helper: escape for safe HTML injection
        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }
    </script>
</body>
</html>
